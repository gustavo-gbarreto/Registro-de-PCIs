{% extends "base.html" %}

{% block title %}Lista de PCIs{% endblock %}

{% block styles %}
<style>
    .modal { display: none; position: fixed; z-index: 1050; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); justify-content: center; align-items: center; overflow-y: auto; }
    .modal-conteudo { background-color: #fefefe; padding: 25px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); position: relative; }
    .fechar { position: absolute; top: 10px; right: 20px; font-size: 1.5rem; font-weight: bold; cursor: pointer; }
    .table thead th { background-color: #007bff; color: white; }
    .required-indicator { color: #dc3545; display: none; }
</style>
{% endblock %}


{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>Lista de PCIs</h1>
    {% if current_user.is_authenticated and current_user.role == 'admin' %}
    <button class="btn btn-primary" id="btn-add-item"><i class="bi bi-plus-circle-fill me-2"></i>Adicionar Item</button>
    {% endif %}
</div>

<div class="card mb-4">
    <div class="card-header"><i class="bi bi-search me-2"></i><strong>Filtrar Registos</strong></div>
    <div class="card-body">
        <div class="row g-3 align-items-center">
            <div class="col-auto"><label for="filter-column" class="col-form-label">Filtrar por:</label></div>
            <div class="col-md-3">
                <select id="filter-column" class="form-select">
                    <option value="2" selected>Serial Number</option>
                    <option value="1">Lote ID</option>
                    <option value="3">Data de Montagem</option>
                    <option value="4">Resultado do Teste</option>
                </select>
            </div>
            <div class="col-md-8"><input type="text" id="filter-input" class="form-control" placeholder="Digite para pesquisar..."></div>
        </div>
    </div>
</div>

<div class="table-responsive">
    <table class="table table-striped table-bordered table-hover">
        <thead>
            <tr>
                <th>Item</th><th>Lote ID</th><th>Serial Number</th><th>Data de Montagem</th><th>Resultado</th><th>Técnico</th><th>Ações</th>
            </tr>
        </thead>
        <tbody id="pci-table-body">
            {% for item in pci_list %}
            <tr>
                <td class="text-center">{{ item.id }}</td>
                <td>{{ item.lote_id }}</td>
                <td>{{ item.serial_number }}</td>
                <td>{{ item.data_de_montagem }}</td>
                <td>{{ item.resultado_do_teste }}</td>
                <td>{{ item.tecnico_do_teste }}</td>
                <td class="text-center">
                    <button class="btn btn-success btn-sm btn-detalhes" data-target="modal-{{ item.id }}">Detalhes</button>
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="7" class="text-center">Nenhum item encontrado no banco de dados.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{% if current_user.is_authenticated and current_user.role == 'admin' %}
<div id="modal-add-item" class="modal">
    <div class="modal-conteudo" style="width: 90%; max-width: 700px;">
        <span class="fechar">&times;</span>
        <ul class="nav nav-tabs" id="add-item-tab" role="tablist">
            <li class="nav-item" role="presentation"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#manual-pane" type="button">Adicionar Manualmente</button></li>
            <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#csv-pane" type="button">Importar para Lista Principal</button></li>
        </ul>
        <div class="tab-content pt-3">
            <div class="tab-pane fade show active" id="manual-pane">
                <form id="form-add-item" action="{{ url_for('admin.cadastro_lotes') }}" method="POST">
                    <h2>Adicionar Novo Item</h2><hr>
                    <div class="row">
                        <div class="col-md-6 mb-3"><label class="form-label">Lote ID</label><input type="text" name="lote_id" class="form-control" required></div>
                        <div class="col-md-6 mb-3"><label class="form-label">Serial Number</label><input type="text" name="serial_number" class="form-control" required></div>
                    </div>
                    <div class="mb-3"><label class="form-label">Data de Montagem</label><input type="date" name="data_de_montagem" class="form-control"></div>
                    <div class="mb-3"><label class="form-label">Resultado do Teste</label><select name="resultado_do_teste" id="add-resultado-teste" class="form-select"><option value="Aprovada" selected>Aprovada</option><option value="Reprovada">Reprovada</option></select></div>
                    <div class="mb-3"><label class="form-label">Técnico do Teste</label><input type="text" name="tecnico_do_teste" class="form-control"></div>
                    <div class="row">
                        <div class="col-md-6 mb-3"><label class="form-label">Retrabalho <span class="required-indicator">*</span></label><input type="text" name="retrabalho" id="add-retrabalho" class="form-control" value="Não"></div>
                        <div class="col-md-6 mb-3"><label class="form-label">Técnico do Retrabalho <span class="required-indicator">*</span></label><input type="text" name="tecnico_do_retrabalho" id="add-tecnico-retrabalho" class="form-control" value="N/A"></div>
                    </div>
                    <div class="mb-3"><label class="form-label">Observações</label><input type="text" name="observacoes" class="form-control" value="--"></div>
                    <div class="d-flex justify-content-end"><button type="submit" class="btn btn-primary">Salvar Novo Item</button></div>
                </form>
            </div>
            <div class="tab-pane fade" id="csv-pane">
                <h2>Importar Itens para a Lista Principal</h2>
                <p>O CSV será adicionado à lista principal de PCIs.</p>
                <form action="{{ url_for('admin.upload_csv') }}" method="POST" enctype="multipart/form-data">
                    <div class="input-group"><input type="file" class="form-control" name="csv_file" accept=".csv" required><button class="btn btn-secondary" type="submit"><i class="bi bi-upload me-2"></i>Importar</button></div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endif %}

{% for item in pci_list %}
<div id="modal-{{ item.id }}" class="modal">
    <div class="modal-conteudo" id="modal-content-{{ item.id }}">
        <span class="fechar">&times;</span>
        <h2>Detalhes: {{ item.serial_number }}</h2><hr>
        <p><strong>Lote ID:</strong> {{ item.lote_id }}</p>
        <p><strong>Data de Montagem:</strong> {{ item.data_de_montagem }}</p>
        <p><strong>Resultado do Teste:</strong> {{ item.resultado_do_teste }}</p>
        <p><strong>Técnico do Teste:</strong> {{ item.tecnico_do_teste }}</p>
        <p><strong>Retrabalho:</strong> {{ item.retrabalho }}</p>
        <p><strong>Técnico do Retrabalho:</strong> {{ item.tecnico_do_retrabalho }}</p>
        <p><strong>Observações:</strong> {{ item.observacoes }}</p>
        {% if current_user.is_authenticated and current_user.role == 'admin' %}
        <div class="mt-4 d-flex justify-content-end gap-2">
            <button class="btn btn-warning" c-get="{{ url_for('admin.obter_pci_form', serial_id=item.id) }}" c-target="#modal-content-{{ item.id }}"><i class="bi bi-pencil-fill me-2"></i>Editar</button>
            <button class="btn btn-danger"
                    c-redirect="{{ url_for('admin.lista_lotes_admin') }}"
                    c-delete="{{ url_for('admin.deletar_pci', serial_id=item.id) }}">
                <i class="bi bi-trash-fill me-2"></i>Deletar
            </button>
        </div>
        {% endif %}
    </div>
</div>
{% endfor %}
{% endblock %}


{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    // Lógica de Filtro (funcional)
    const filterInput = document.getElementById('filter-input');
    const filterColumn = document.getElementById('filter-column');
    const tableBody = document.getElementById('pci-table-body');
    function filterTable() {
        if (!filterInput || !filterColumn || !tableBody) return;
        const query = filterInput.value.toUpperCase();
        const columnIndex = parseInt(filterColumn.value, 10);
        const rows = tableBody.getElementsByTagName('tr');
        for (let i = 0; i < rows.length; i++) {
            const cell = rows[i].getElementsByTagName('td')[columnIndex];
            if (cell) {
                const cellText = cell.textContent || cell.innerText;
                if (cellText.toUpperCase().indexOf(query) > -1) {
                    rows[i].style.display = "";
                } else {
                    rows[i].style.display = "none";
                }
            }
        }
    }
    if (filterInput) {
        filterInput.addEventListener('keyup', filterTable);
        filterColumn.addEventListener('change', filterTable);
    }
    
    // Lógica para o formulário de ADIÇÃO MANUAL (funcional)
    const formAddItem = document.getElementById('form-add-item');
    if (formAddItem) {
        formAddItem.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!formAddItem.checkValidity()) { e.stopPropagation(); formAddItem.reportValidity(); return; }
            const data = Object.fromEntries(new FormData(formAddItem).entries());
            const resp = await fetch(formAddItem.action, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
            if (resp.ok) { window.location.reload(); } 
            else { const err = await resp.json(); alert(err.message ? 'Erro: ' + err.message : 'Ocorreu um erro.'); }
        });
    }

    // --- INÍCIO DA CORREÇÃO: Lógica completa para o formulário de EDIÇÃO ---
    // Usamos 'delegação de evento' para "ouvir" por submissões no corpo da página
    document.body.addEventListener('submit', async (e) => {
        // Verificamos se o formulário submetido é um formulário de edição
        if (e.target && e.target.id.startsWith('edit-form-')) {
            const form = e.target;
            e.preventDefault(); // Impede o envio padrão

            if (!form.checkValidity()) {
                e.stopPropagation();
                form.reportValidity();
                return;
            }
            
            const data = Object.fromEntries(new FormData(form).entries());

            // Envia os dados para o backend usando o método 'PUT'
            const response = await fetch(form.action, {
                method: 'PUT', // <-- AQUI ESTÁ A CORREÇÃO CRUCIAL
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            if (response.ok) {
                window.location.reload(); // Recarrega a página para ver a alteração
            } else {
                alert('Ocorreu um erro ao salvar as alterações.');
            }
        }
    });
    // --- FIM DA CORREÇÃO ---

    // Lógica COMPLETA para abrir e fechar TODOS os modais (funcional)
    const btnAddItem = document.getElementById('btn-add-item');
    if (btnAddItem) { btnAddItem.addEventListener('click', () => { document.getElementById('modal-add-item').style.display = 'flex'; }); }
    document.querySelectorAll('.btn-detalhes').forEach(b => { b.addEventListener('click', () => { const modal = document.getElementById(b.dataset.target); if (modal) modal.style.display = 'flex'; }); });
    document.querySelectorAll('.fechar').forEach(b => { b.addEventListener('click', () => { b.closest('.modal').style.display = 'none'; }); });
    window.addEventListener('click', (e) => { if (e.target.classList.contains('modal')) e.target.style.display = 'none'; });

    // Re-inicializa o cru.js (para botões de DELETAR e EDITAR)
    if (window.$C) { $C(); }
});
</script>
{% endblock %}