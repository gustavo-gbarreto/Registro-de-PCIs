{% extends "base.html" %}
{% block title %}Lista de Lotes{% endblock %}
{% block styles %}
<style>
    .modal { display: none; position: fixed; z-index: 1050; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); justify-content: center; align-items: center; overflow-y: auto; }
    .modal-conteudo { background-color: #fefefe; padding: 25px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); position: relative; }
    .fechar { position: absolute; top: 10px; right: 20px; font-size: 1.5rem; font-weight: bold; cursor: pointer; }
    .table thead th { background-color: #007bff; color: white; }
    .required-indicator { color: #dc3545; display: none; }
</style>
{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>Lista de PCIs</h1>
    {% if current_user and current_user.is_authenticated and current_user.role == 'admin' %}
    <button class="btn btn-primary" id="btn-add-item"><i class="bi bi-plus-circle-fill me-2"></i>Adicionar Item</button>
    {% endif %}
</div>
{% if current_user and current_user.is_authenticated and current_user.role == 'admin' %}
<div class="card mb-4">
    <div class="card-header"><strong>Importar Itens de Ficheiro CSV</strong></div>
    <div class="card-body">
        <form action="{{ url_for('admin.upload_csv') }}" method="POST" enctype="multipart/form-data">
            <div class="input-group">
                <input type="file" class="form-control" name="csv_file" accept=".csv" required>
                <button class="btn btn-secondary" type="submit"><i class="bi bi-upload me-2"></i>Importar</button>
            </div>
            <div class="form-text mt-2">Colunas: <strong>Lote_ID, Serial_Number, Data_de_Montagem, Resultado_do_Teste, tecnico_do_teste, Retrabalho, Tecnico_do_Retrabalho, Observacoes</strong></div>
        </form>
    </div>
</div>
{% endif %}
<div class="table-responsive">
    <table class="table table-striped table-bordered table-hover">
        <thead>
            <tr>
                <th>Item</th> <th>Lote ID</th> <th>Serial Number</th> <th>Data de Montagem</th> <th>Resultado</th> <th>Técnico</th> <th>Ações</th>
            </tr>
        </thead>
        <tbody>
            {% for id, dados in pci_list.items() %}
            <tr>
                <td class="text-center">{{ id }}</td> <td>{{ dados.Lote_ID }}</td> <td>{{ dados.Serial_Number }}</td> <td>{{ dados.Data_de_Montagem }}</td> <td>{{ dados.Resultado_do_Teste }}</td> <td>{{ dados.tecnico_do_teste }}</td>
                <td class="text-center"><button class="btn btn-success btn-sm btn-detalhes" data-target="modal-{{ id }}">Detalhes</button></td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% if current_user and current_user.is_authenticated and current_user.role == 'admin' %}
<div id="modal-add-item" class="modal">
    <div class="modal-conteudo">
        <span class="fechar">&times;</span>
        <form id="form-add-item" action="{{ url_for('admin.cadastro_lotes') }}" method="POST">
            <h2>Adicionar Novo Item Manualmente</h2><hr>
            <div class="row">
                <div class="col-md-6 mb-3"><label class="form-label">Lote ID</label><input type="text" name="Lote_ID" class="form-control" required></div>
                <div class="col-md-6 mb-3"><label class="form-label">Serial Number</label><input type="text" name="Serial_Number" class="form-control" required></div>
            </div>
            <div class="mb-3"><label class="form-label">Data de Montagem</label><input type="date" name="Data_de_Montagem" class="form-control" required></div>
            <div class="mb-3"><label class="form-label">Resultado do Teste</label><select name="Resultado_do_Teste" id="add-resultado-teste" class="form-select" required><option value="Aprovada" selected>Aprovada</option><option value="Reprovada">Reprovada</option></select></div>
            <div class="mb-3"><label class="form-label">Técnico do Teste</label><input type="text" name="tecnico_do_teste" class="form-control" required></div>
            <div class="row">
                <div class="col-md-6 mb-3"><label class="form-label" for="add-retrabalho">Retrabalho <span class="required-indicator">*</span></label><input type="text" name="Retrabalho" id="add-retrabalho" class="form-control" value="Não"></div>
                <div class="col-md-6 mb-3"><label class="form-label" for="add-tecnico-retrabalho">Técnico do Retrabalho <span class="required-indicator">*</span></label><input type="text" name="Tecnico_do_Retrabalho" id="add-tecnico-retrabalho" class="form-control" value="N/A"></div>
            </div>
            <div class="mb-3"><label class="form-label">Observações</label><input type="text" name="Observacoes" class="form-control" value="--"></div>
            <div class="d-flex justify-content-end"><button type="submit" class="btn btn-primary">Salvar Novo Item</button></div>
        </form>
    </div>
</div>
{% endif %}
{% for id, dados in pci_list.items() %}
<div id="modal-{{ id }}" class="modal">
    <div class="modal-conteudo" id="modal-content-{{ id }}">
        <span class="fechar">&times;</span>
        <h2>Detalhes: {{ dados.Serial_Number }}</h2><hr>
        <p><strong>Lote ID:</strong> {{ dados.Lote_ID }}</p> <p><strong>Data de Montagem:</strong> {{ dados.Data_de_Montagem }}</p> <p><strong>Resultado do Teste:</strong> {{ dados.Resultado_do_Teste }}</p> <p><strong>Técnico do Teste:</strong> {{ dados.tecnico_do_teste }}</p> <p><strong>Retrabalho:</strong> {{ dados.Retrabalho }}</p> <p><strong>Técnico do Retrabalho:</strong> {{ dados.Tecnico_do_Retrabalho }}</p> <p><strong>Observações:</strong> {{ dados.Observacoes }}</p>
        {% if current_user and current_user.is_authenticated and current_user.role == 'admin' %}
        <div class="mt-4 d-flex justify-content-end gap-2">
            <button class="btn btn-warning" c-get="{{ url_for('admin.obter_pci_form', serial_id=id) }}" c-target="#modal-content-{{ id }}"><i class="bi bi-pencil-fill me-2"></i>Editar</button>
            <button class="btn btn-danger" c-redirect="{{ url_for('admin.lista_lotes_admin') }}" c-delete="{{ url_for('admin.deletar_pci', lote_id=dados.Lote_ID, serial_id=id) }}"><i class="bi bi-trash-fill me-2"></i>Deletar</button>
        </div>
        {% endif %}
    </div>
</div>
{% endfor %}
{% endblock %}
{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    const formAddItem = document.getElementById('form-add-item');
    if (formAddItem) {
        formAddItem.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!formAddItem.checkValidity()) { e.stopPropagation(); formAddItem.reportValidity(); return; }
            const data = Object.fromEntries(new FormData(formAddItem).entries());
            const resp = await fetch(formAddItem.action, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
            if (resp.ok) { window.location.href = "{{ url_for('admin.lista_lotes_admin') }}"; } 
            else { const err = await resp.json(); alert(err.message ? 'Erro: ' + err.message : 'Ocorreu um erro.'); }
        });
    }
    const resAdd = document.getElementById('add-resultado-teste');
    if (resAdd) {
        const retrabalhoAdd = document.getElementById('add-retrabalho');
        const tecRetrabalhoAdd = document.getElementById('add-tecnico-retrabalho');
        const indicatorsAdd = document.querySelectorAll('#form-add-item .required-indicator');
        const updateAddFields = () => {
            const isReprovado = resAdd.value === 'Reprovada';
            retrabalhoAdd.required = isReprovado;
            tecRetrabalhoAdd.required = isReprovado;
            indicatorsAdd.forEach(i => i.style.display = isReprovado ? 'inline' : 'none');
            if (isReprovado) {
                if (retrabalhoAdd.value === 'Não') retrabalhoAdd.value = '';
                if (tecRetrabalhoAdd.value === 'N/A') tecRetrabalhoAdd.value = '';
            }
        };
        resAdd.addEventListener('change', updateAddFields);
    }
    document.body.addEventListener('submit', async (e) => {
        if (e.target && e.target.id.startsWith('edit-form-')) {
            const form = e.target;
            e.preventDefault();
            if (!form.checkValidity()) { e.stopPropagation(); form.reportValidity(); return; }
            const data = Object.fromEntries(new FormData(form).entries());
            const resp = await fetch(form.action, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
            if (resp.ok) { window.location.href = "{{ url_for('admin.lista_lotes_admin') }}"; } 
            else { alert('Ocorreu um erro ao salvar as alterações.'); }
        }
    });
    document.body.addEventListener('change', (e) => {
        if (e.target && e.target.id.startsWith('edit-resultado-teste-')) {
            const resEdit = e.target;
            const id = resEdit.id.replace('edit-resultado-teste-', '');
            const retrabalhoEdit = document.getElementById('edit-retrabalho-' + id);
            const tecRetrabalhoEdit = document.getElementById('edit-tecnico-retrabalho-' + id);
            const indicatorsEdit = document.querySelectorAll(`#edit-form-${id} .required-indicator`);
            const isReprovado = resEdit.value === 'Reprovada';
            retrabalhoEdit.required = isReprovado;
            tecRetrabalhoEdit.required = isReprovado;
            indicatorsEdit.forEach(i => i.style.display = isReprovado ? 'inline' : 'none');
        }
    });
    const btnAddItem = document.getElementById('btn-add-item');
    if (btnAddItem) { btnAddItem.addEventListener('click', () => { document.getElementById('modal-add-item').style.display = 'flex'; }); }
    document.querySelectorAll('.btn-detalhes').forEach(b => { b.addEventListener('click', () => { const modal = document.getElementById(b.dataset.target); if (modal) modal.style.display = 'flex'; }); });
    document.querySelectorAll('.fechar').forEach(b => { b.addEventListener('click', () => { b.closest('.modal').style.display = 'none'; }); });
    window.addEventListener('click', (e) => { if (e.target.classList.contains('modal')) e.target.style.display = 'none'; });
    if (window.$C) $C();
});
</script>
{% endblock %}