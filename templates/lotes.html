{% extends "base.html" %}

{% block title %}Lista de Lotes - PCIs{% endblock %}

{% block styles %}
  <style>
    .modal { display: none; position: fixed; z-index: 1050; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); justify-content: center; align-items: center; overflow-y: auto; }
    .modal-conteudo { background-color: #fefefe; padding: 25px; border: 1px solid #888; width: 90%; max-width: 600px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); position: relative; margin: 2rem 0; }
    .fechar { position: absolute; top: 10px; right: 20px; font-size: 1.5rem; font-weight: bold; cursor: pointer; }
    .table thead th { background-color: #007bff; color: white; }
    .required-indicator { color: #dc3545; display: none; }
  </style>
{% endblock %}


{% block content %}
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1>Lista de PCIs</h1>
    <button class="btn btn-primary btn-lg" id="btn-add-item">
      Adicionar Novo Item
    </button>
  </div>

  <div class="table-responsive">
    <table class="table table-striped table-bordered table-hover">
      <thead>
        <tr>
          <th>Item</th>
          <th>Lote ID</th>
          <th>Serial Number</th>
          <th>Data de Montagem</th>
          <th>Resultado do Teste</th>
          <th>Técnico</th>
          <th>Ações</th>
        </tr>
      </thead>
      <tbody>
        {% for id, dados in pci_list.items() %}
        <tr>
            <td class="text-center">{{ id }}</td>
            <td>{{ dados.Lote_ID }}</td>
            <td>{{ dados.Serial_Number }}</td>
            <td>{{ dados.Data_de_Montagem }}</td>
            <td>{{ dados.Resultado_do_Teste }}</td>
            <td>{{ dados.tecnico_do_teste }}</td>
            <td class="text-center">
              <button class="btn btn-success btn-sm btn-detalhes" data-target="modal-{{ id }}">Ver Detalhes</button>
            </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  
  <div id="modal-add-item" class="modal">
    <div class="modal-conteudo">
      <form id="form-add-item" action="{{ url_for('admin.cadastro_lotes') }}" method="POST">
        <span class="fechar">&times;</span>
        <h2>Adicionar Novo Item</h2>
        <div class="mb-3"><label class="form-label">Lote ID</label><input type="text" name="Lote_ID" class="form-control" required></div>
        <div class="mb-3"><label class="form-label">Serial Number</label><input type="text" name="Serial_Number" class="form-control" required></div>
        <div class="mb-3"><label class="form-label">Data de Montagem</label><input type="date" name="Data_de_Montagem" class="form-control" required></div>
        <div class="mb-3"><label class="form-label">Resultado do Teste</label><select name="Resultado_do_Teste" id="add-resultado-teste" class="form-select" required><option value="Aprovada" selected>Aprovada</option><option value="Reprovada">Reprovada</option></select></div>
        <div class="mb-3"><label class="form-label">Técnico do Teste</label><input type="text" name="tecnico_do_teste" class="form-control" required></div>
        <div class="mb-3"><label class="form-label" for="add-retrabalho">Retrabalho <span class="required-indicator">*</span></label><input type="text" name="Retrabalho" id="add-retrabalho" class="form-control" value="Não"></div>
        <div class="mb-3"><label class="form-label" for="add-tecnico-retrabalho">Técnico do Retrabalho <span class="required-indicator">*</span></label><input type="text" name="Tecnico_do_Retrabalho" id="add-tecnico-retrabalho" class="form-control" value="N/A"></div>
        <div class="mb-3"><label class="form-label">Observações</label><input type="text" name="Observacoes" class="form-control" value="--"></div>
        <div class="d-flex justify-content-end"><button type="submit" class="btn btn-primary">Salvar Novo Item</button></div>
      </form>
    </div>
  </div>

  {% for id, dados in pci_list.items() %}
  <div id="modal-{{ id }}" class="modal">
    <div class="modal-conteudo" id="modal-content-{{ id }}">
      <span class="fechar">&times;</span>
      <h2>Detalhes: {{ dados.Serial_Number }}</h2>
      <p><strong>Lote ID:</strong> {{ dados.Lote_ID }}</p>
      <p><strong>Data de Montagem:</strong> {{ dados.Data_de_Montagem }}</p>
      <p><strong>Resultado do Teste:</strong> {{ dados.Resultado_do_Teste }}</p>
      <p><strong>Técnico do Teste:</strong> {{ dados.tecnico_do_teste }}</p>
      <hr>
      <p><strong>Retrabalho:</strong> {{ dados.Retrabalho }}</p>
      <p><strong>Técnico do Retrabalho:</strong> {{ dados.Tecnico_do_Retrabalho }}</p>
      <p><strong>Observações:</strong> {{ dados.Observacoes }}</p>
      <div class="mt-4 d-flex justify-content-end gap-2">
        <button class="btn btn-warning" c-get="{{ url_for('admin.obter_pci_form', serial_id=id) }}" c-target="#modal-content-{{ id }}">
          Editar
        </button>
        <button class="btn btn-danger" c-redirect="{{ url_for('admin.lista_lotes_admin') }}" c-delete="{{ url_for('admin.deletar_pci', lote_id=dados.Lote_ID, serial_id=id) }}">
          Deletar Item
        </button>
      </div>
    </div>
  </div>
  {% endfor %}
{% endblock %}


{% block scripts %}
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const formAddItem = document.getElementById('form-add-item');
      if (formAddItem) {
        formAddItem.addEventListener('submit', async (event) => {
          event.preventDefault();
          const formData = new FormData(formAddItem);
          const data = Object.fromEntries(formData.entries());
          const response = await fetch(formAddItem.action, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
          if (response.ok) {
            window.location.href = "{{ url_for('admin.lista_lotes_admin') }}";
          } else {
            const errorData = await response.json();
            if (errorData.message) {
              alert('Erro ao salvar: ' + errorData.message);
            } else {
              alert('Ocorreu um erro desconhecido.');
            }
          }
        });
      }

      const resultadoSelect = document.getElementById('add-resultado-teste');
      if (resultadoSelect) {
        const retrabalhoInput = document.getElementById('add-retrabalho');
        const tecnicoRetrabalhoInput = document.getElementById('add-tecnico-retrabalho');
        const retrabalhoIndicator = document.querySelector('label[for="add-retrabalho"] .required-indicator');
        const tecnicoRetrabalhoIndicator = document.querySelector('label[for="add-tecnico-retrabalho"] .required-indicator');
        function atualizarCamposCondicionais() {
          const isReprovado = resultadoSelect.value === 'Reprovada';
          retrabalhoInput.required = isReprovado;
          tecnicoRetrabalhoInput.required = isReprovado;
          retrabalhoIndicator.style.display = isReprovado ? 'inline' : 'none';
          tecnicoRetrabalhoIndicator.style.display = isReprovado ? 'inline' : 'none';
          if (isReprovado) {
            if (retrabalhoInput.value === 'Não') retrabalhoInput.value = '';
            if (tecnicoRetrabalhoInput.value === 'N/A') tecnicoRetrabalhoInput.value = '';
          }
        }
        resultadoSelect.addEventListener('change', atualizarCamposCondicionais);
      }

      const btnAddItem = document.getElementById('btn-add-item');
      if (btnAddItem) {
        btnAddItem.addEventListener('click', () => {
          document.getElementById('modal-add-item').style.display = 'flex';
        });
      }

      document.querySelectorAll('.btn-detalhes').forEach(button => {
        button.addEventListener('click', () => {
          const modalId = button.getAttribute('data-target');
          const modal = document.getElementById(modalId);
          if (modal) {
            modal.style.display = 'flex';
          }
        });
      });

      document.querySelectorAll('.fechar').forEach(button => {
        button.addEventListener('click', () => {
          button.closest('.modal').style.display = 'none';
        });
      });

      window.addEventListener('click', (event) => {
        if (event.target.classList.contains('modal')) {
          event.target.style.display = 'none';
        }
      });

      if (window.$C) {
        $C();
      }
    });
  </script>
{% endblock %}